<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Huopa Proxy</title>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Roboto+Flex:opsz,wght@8..144,100..1000&display=swap" rel="stylesheet">

<style>
    body {
      font-family: sans-serif;
      overflow: hidden;
      margin: 0;
      background-color: rgba(25, 25, 25);
      color: white;
    }

    .page {
      width: 100%;
      height: calc(100% - 6.75em);
      position: absolute;
      top: 6.75em;
      left: 0;
      border: none;
      background-color: white;
    }

    input {
        width: calc(100% - 3em);
        height: 0.7em;
        padding: 1em;
        border-radius: 2em;
        background-color: rgb(40, 40, 40);
        border-color: rgb(60, 60, 60);
        border-style: solid;
        border-width: 1px;
        position: absolute;
        left: 50%;
        top: 4.5em;
        transform: translateX(-50%);
        color: white;
        transition: background-color 0.1s;
        outline: none;
    }

    input:hover {
        background-color: rgb(50, 50, 50);
    }

    input:focus {
        border-color: #42c3ed;
        border-width: 1.5px;
    }

    #newTabButton {
        transition: ease-in 0.1s;
        margin: 0 1em;
        background-color: rgb(40, 40, 40);
        border-style: none;
        padding: 0.5em;
        color: white;
        border-radius: 50%;
        height: 31px;
        width: 31px;
        cursor: pointer;
        user-select: none;
        -webkit-user-select: none;
        -ms-user-select: none;
    }

    #tabBar {
        display: flex;
        align-items: center;
        height: 60px;
        overflow-x: auto;
    }

    .tab {
        cursor: pointer;
        padding: 0.75em;
        margin: 1em;
        margin-right: 0;
        background-color: rgb(40, 40, 40);
        border-radius: 1em;
        font-size: 0.66em;
        user-select: none;
        -webkit-user-select: none;
        -ms-user-select: none;
    }

    #tabBar > * {
        flex-shrink: 0;
    }
    .selectedTab {
        background-color: rgb(55, 55, 55) !important;
    }

    .closeTab {
        background-color: rgb(80, 80, 80);
        border-style: none;
        color: white;
        margin-left: 0.5em;
        border-radius: 50%;
        width: 18px;
        height: 18px;
        font-size: 1em;
        cursor: pointer;
    }

    .tabText {
        padding-left: 0.25em;
        cursor: pointer;
    }

    #innerTabs {
        display: flex;
    }
</style>
</head>
<body>
<div id="tabBar">
    <div id="innerTabs">
        <div class="tab selectedTab" onclick="openTab(0)" id="tab0">
            <label class="tabText">Loading...</label>
            <button onclick="closeTab(0)" class="closeTab">×</button>
        </div>
    </div>
    <button id="newTabButton" onclick="newTab()">+</button>
</div>
<input id="searchInput">
<script type="module">
    const url = new URL(window.location.href);
    const kiosk = url.searchParams.get("kiosk");
    let selectedTab = 0;
    let newTabId = 1;
    const searchInput = document.getElementById("searchInput");
    let targetUrl = "https://www.startpage.com/";
    if (kiosk) {
        targetUrl = kiosk;
        searchInput.remove();
        document.getElementById("tabBar").remove();
        document.getElementById("0").style.height = "100%";
        document.getElementById("0").style.top = "0";
    }
    let currentUrl = null;
    const serverUrl = "https://allucat1000-huopaproxy-29.deno.dev/proxy";
    const server = new URL(serverUrl);
    const reloadHotkey = (e) => {
        if (!selectedTab) return;
        const isReload = (e.key === 'F5') || ((e.ctrlKey || e.metaKey) && e.code === 'KeyR');
        if (!isReload) return;
        e.preventDefault();
        e.stopPropagation();
        if (currentUrl) {
            loadPage(currentUrl);
        } else {
            if (document.getElementById("0")) document.getElementById("0").remove();
        }
    };
    window.addEventListener('keydown', reloadHotkey, { capture: true });

    async function closeTab(id) {
        const tab = document.getElementById(id);
        const tabMark = document.getElementById(`tab${id}`);
        if (tab) tab.remove();
        if (tabMark) tabMark.remove();

        const remainingTabs = document.getElementById("innerTabs").children;

        if (remainingTabs.length === 0) {
            selectedTab = null;
            newTabId = 0;
            searchInput.disabled = true;
            searchInput.value = "";
            return;
        }

        if (id === selectedTab) {
            const firstRemaining = remainingTabs[0];
            const newId = firstRemaining.id.replace("tab", "");
            openTab(newId);
        }
    }

    async function newTab() {
        searchInput.disabled = false;

        const id = newTabId++;

        const createdTab = document.createElement("div");
        createdTab.classList.add("tab");
        createdTab.id = `tab${id}`;
        createdTab.onclick = () => openTab(id);

        const siteName = document.createElement("label");
        siteName.classList.add("tabText");
        siteName.textContent = targetUrl;

        const closeTabButton = document.createElement("button");
        closeTabButton.classList.add("closeTab");
        closeTabButton.onclick = () => closeTab(id);
        closeTabButton.textContent = "×";

        createdTab.append(siteName, closeTabButton);
        document.getElementById("innerTabs").append(createdTab);

        const newFrame = document.createElement("iframe");
        newFrame.classList.add("page");
        newFrame.style.display = "none";
        newFrame.id = id;
        document.body.append(newFrame);

        openTab(id);
        loadPage(targetUrl);
    }

    async function openTab(id) {
        const newTab = document.getElementById(Number(id));
        if (!newTab) throw new Error("Tried to access tab that doesn't exist! Id: " + id);

        if (selectedTab !== null && selectedTab !== undefined) {
            const oldTab = document.getElementById(selectedTab);
            const oldTabMark = document.getElementById(`tab${selectedTab}`);
            if (oldTabMark) oldTabMark.classList.remove("selectedTab");
            if (oldTab) oldTab.style.display = "none";
        }

        selectedTab = Number(id);
        const newTabMark = document.getElementById(`tab${selectedTab}`);
        if (newTabMark) newTabMark.classList.add("selectedTab");
        newTab.style.display = "block";
        if (newTabMark) searchInput.value = newTabMark.children[0].textContent;
    }


    window.newTab = newTab
    window.closeTab = closeTab
    window.openTab = openTab

    function attachIframeHotkey() {
        try {
            const w = frame.contentWindow;
            w.addEventListener('keydown', reloadHotkey, { capture: true });
        } catch {}
    }
    if (!kiosk) {
        searchInput.addEventListener("keydown", (e) => {
            if (e.key === "Enter") {
                e.preventDefault();
                if (searchInput.value) loadPage(searchInput.value, true);
            }
        })
    }
    function deproxify(u, currentRemoteBase) {
        try {
        const abs = new URL(u, currentRemoteBase);
        if (abs.origin === server.origin && abs.pathname === server.pathname) {
            const inner = abs.searchParams.get("url");
            return inner ? inner : abs.href;
        }
        return abs.href;
        } catch { return u; }
    }
    function renderIntoIframe(html, remoteUrl) {
        currentUrl = remoteUrl;
        if (!kiosk) searchInput.value = currentUrl;

        if (document.getElementById(selectedTab)) document.getElementById(selectedTab).remove();
        const frame = document.createElement("iframe");
        if (kiosk) {
            frame.style.height = "100%";
            frame.style.top = "0";
        }
        frame.id = selectedTab;
        frame.classList.add("page");
        document.body.append(frame);
        const tab = document.getElementById(`tab${selectedTab}`);
        if (tab) tab.children[0].textContent = remoteUrl;

        frame.contentWindow.addEventListener("keydown", (e) => {
            if (e.key.toLowerCase() === "r" && e.ctrlKey) {
                e.preventDefault();
                loadPage(currentUrl);
            }
        });

        const doc = frame.contentDocument || frame.contentWindow.document;
        doc.open(); doc.write(html); doc.close();
        attachIframeHotkey();

        const win = frame.contentWindow;
 
        win.eval(`
        document.requestStorageAccess = async () => Promise.resolve();
        document.hasStorageAccess = async () => true;
        `);

        // Safe nav patches
        win.open = (u) => { loadPage(deproxify(u, remoteUrl)); return null; };
        try {
            win.location.assign = (u) => loadPage(deproxify(u, remoteUrl));
            win.location.replace = (u) => loadPage(deproxify(u, remoteUrl));
            win.location.reload  = ()  => loadPage(remoteUrl);
        } catch {}

        // Links
        doc.addEventListener("click", e => {
            const a = e.target.closest("a");
            if (!a) return;
            e.preventDefault();
            const rawHref = a.getAttribute("href") || a.href;
            const next = deproxify(rawHref, remoteUrl);
            loadPage(next);
        });

        // Forms
        win.history.pushState = () => {}
        win.history.replaceState = () => {}

        const submitHandler = e => {
            const form = e.target.closest("form");
            if (!form) return;

            e.preventDefault();
            
            const rawAction = form.getAttribute("action") || "";
            const action = deproxify(rawAction || remoteUrl, remoteUrl);
            const fd = new FormData(form);
            const params = new URLSearchParams(fd);
            if ((form.method || "get").toLowerCase() === "post") {
                fetch(server.href + "?url=" + encodeURIComponent(action), {
                    method: "POST",
                    body: params,
                    headers: { "Content-Type": "application/x-www-form-urlencoded" },
                    credentials: "include"
                })
                .then(r => r.text())
                .then(html => renderIntoIframe(html, action));
            } else {
                const urlWithQs = action + (action.includes("?") ? "&" : "?") + params.toString();
                loadPage(urlWithQs);
            }
        };
        doc.addEventListener("submit", submitHandler, true);
        doc.querySelectorAll("form").forEach(form => {
            const nativeSubmit = form.submit;
            form.submit = function() {
                const ev = new Event("submit", { cancelable: true, bubbles: true });
                if (form.dispatchEvent(ev)) {
                    nativeSubmit.apply(form, arguments);
                }
            };
        });


        // Meta refresh
        doc.querySelectorAll('meta[http-equiv="refresh"]').forEach(meta => {
            const content = meta.getAttribute("content") || "";
            const match = content.match(/^\s*(\d+)\s*;\s*url=(.+)$/i);
            if (match) {
            const delay = parseInt(match[1], 10) * 1000;
            const raw = match[2].trim();
            const next = deproxify(raw, remoteUrl);
            setTimeout(() => loadPage(next), delay);
            }
        });

        const noop = () => {};

        win.addEventListener("popstate", e => {} );
        injectMutationObserver(win, serverUrl + "?url=" + encodeURIComponent(remoteUrl), serverUrl, targetUrl)
    }
    function injectMutationObserver(targetWindow, rewriteUrl, serverUrl, targetUrl) {
        const attrMap = {
            a: "href",
            link: "href",
            img: "src",
            script: "src",
            iframe: "src",
            frame: "src",
            embed: "src",
            object: "data",
            source: "src",
            track: "src",
            audio: "src",
            video: "src",
            form: "action",
            area: "href",
        };

        const script = `
            (function() {
                const attrMap = ${JSON.stringify(attrMap)};
                const serverUrl = "${serverUrl}";
                const targetUrl = "${targetUrl}";

                function rewriteUrlSafe(url) {
                    try {
                        const absoluteUrl = new URL(url, targetUrl).href;
                        return serverUrl + "?url=" + encodeURIComponent(absoluteUrl);
                    } catch {
                        return url;
                    }
                }

                function rewriteCss(css) {
                    if (!css) return css;
                    return css.replace(/url\(\\s*(['"]?)(.*?)\\1\s*\\)/g, (_, quote, url) => {
                        let clean = url.trim();
                        if (clean.startsWith("data:")) return \`url(\${url})\`;
                        return \`url(\${rewriteUrlSafe(clean)})\`;
                    });
                }

                function rewriteElement(el) {
                    // attributes
                    for (const [tag, attr] of Object.entries(attrMap)) {
                        if (el.tagName && el.tagName.toLowerCase() === tag) {
                            let val = el.getAttribute(attr);
                            if (val && !val.startsWith("data:") && !val.startsWith("javascript:")) {
                                el.setAttribute(attr, rewriteUrlSafe(val));
                            }
                        }
                    }

                    // inline styles
                    if (el.hasAttribute && el.hasAttribute("style")) {
                        el.setAttribute("style", rewriteCss(el.getAttribute("style")));
                    }

                    // style tags
                    if (el.tagName && el.tagName.toLowerCase() === "style") {
                        el.textContent = rewriteCss(el.textContent);
                    }

                    // srcsets
                    if (el.tagName && ["img", "source"].includes(el.tagName.toLowerCase())) {
                        let srcset = el.getAttribute("srcset");
                        if (srcset) {
                            let rewritten = srcset
                                .split(",")
                                .map(entry => {
                                    let [url, size] = entry.trim().split(/\\s+/, 2);
                                    return rewriteUrlSafe(url) + (size ? " " + size : "");
                                })
                                .join(", ");
                            el.setAttribute("srcset", rewritten);
                        }
                    }
                }

                const observer = new MutationObserver(mutations => {
                    for (const mutation of mutations) {
                        mutation.addedNodes.forEach(node => {
                            if (node.nodeType === Node.ELEMENT_NODE) {
                                rewriteElement(node);
                                node.querySelectorAll && node.querySelectorAll("*").forEach(rewriteElement);
                            }
                        });
                    }
                });

                observer.observe(document.documentElement, { childList: true, subtree: true });

                document.querySelectorAll("*").forEach(rewriteElement);
            })();
        `;

        const scriptEl = targetWindow.document.createElement("script");
        scriptEl.textContent = script;
        try {
            targetWindow.document.body.appendChild(scriptEl);
        } catch {}
    }


    async function loadPage(rawRemoteUrl, search = false) {
        let remoteUrl = rawRemoteUrl;

        if (rawRemoteUrl === "about:blank") {
            if (document.getElementById(selectedTab)) document.getElementById(selectedTab).remove();
            return;
        }
        if (!remoteUrl.startsWith("http://") && !remoteUrl.startsWith("https://")) {
            remoteUrl = "http://" + remoteUrl;
        }
        if (search) {
            if (!isValidURL(remoteUrl)) {
                remoteUrl = "https://startpage.com/sp/search?q=" + rawRemoteUrl.replaceAll(" ", "+");
            }
        }
        const raw = await fetch(server.href + "?url=" + encodeURIComponent(remoteUrl), {
            credentials: 'include'
        });
        const html = await raw.text();
        renderIntoIframe(html, remoteUrl);
    }
    function isValidURL(str) {
        try {
            const data = new URL(str);
            if (data.protocol.startsWith("http")) return true;
            return false;
        } catch {
            return false;
        }
    }

    window.loadPage = loadPage;
    loadPage(targetUrl);
</script>
</body>
</html>
