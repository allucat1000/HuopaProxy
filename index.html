<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>HuopaWebProxy</title>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Roboto+Flex:opsz,wght@8..144,100..1000&display=swap" rel="stylesheet">

<style>
    body {
      font-family: sans-serif;
      overflow: hidden;
      margin: 0;
      background-color: rgba(25, 25, 25);
    }
    #page {
      width: 100%;
      height: calc(100% - 3.25em);
      position: absolute;
      top: 3.25em;
      left: 0;
      border: none;
    }
    input {
        width: calc(100% - 3em);
        height: 0.7em;
        padding: 1em;
        border-radius: 2em;
        background-color: rgb(40, 40, 40);
        border-color: rgb(60, 60, 60);
        border-style: solid;
        border-width: 1px;
        position: absolute;
        left: 50%;
        top: 0.5em;
        transform: translateX(-50%);
        color: black;
    }
</style>
</head>
<body>
<input id="searchInput">
<iframe id="page"></iframe>
<script type="module">
    const searchInput = document.getElementById("searchInput");
    const targetUrl = "https://www.startpage.com/"
    let currentUrl = null;
    const serverUrl = "https://allucat1000-huopaproxy-29.deno.dev/proxy";
    const server = new URL(serverUrl);
    const reloadHotkey = (e) => {
        const isReload = (e.key === 'F5') || ((e.ctrlKey || e.metaKey) && e.code === 'KeyR');
        if (!isReload) return;
        e.preventDefault();
        e.stopPropagation();
        if (currentUrl) {
            loadPage(currentUrl);
        } else {
            if (document.getElementById("page")) document.getElementById("page").remove();
        }
    };
    window.addEventListener('keydown', reloadHotkey, { capture: true });

    function attachIframeHotkey() {
        try {
        const w = frame.contentWindow;
        w.addEventListener('keydown', reloadHotkey, { capture: true });
        } catch {}
    }

    searchInput.addEventListener("keydown", (e) => {
        if (e.key === "Enter") {
            e.preventDefault();
            if (searchInput.value) loadPage(searchInput.value, true);
        }
    })
    function deproxify(u, currentRemoteBase) {
        try {
        const abs = new URL(u, currentRemoteBase);
        if (abs.origin === server.origin && abs.pathname === server.pathname) {
            const inner = abs.searchParams.get("url");
            return inner ? inner : abs.href;
        }
        return abs.href;
        } catch { return u; }
    }
    function renderIntoIframe(html, remoteUrl) {
        currentUrl = remoteUrl;
        searchInput.value = "";
        searchInput.placeholder = currentUrl;

        // Replace iframe
        if (document.getElementById("page")) document.getElementById("page").remove();
        const frame = document.createElement("iframe");
        frame.id = "page";
        document.body.append(frame);

        // hotkey inside frame
        frame.contentWindow.addEventListener("keydown", (e) => {
            if (e.key.toLowerCase() === "r" && e.ctrlKey) {
            e.preventDefault();
            loadPage(currentUrl);
            }
        });

        const doc = frame.contentDocument || frame.contentWindow.document;
        doc.open(); doc.write(html); doc.close();
        attachIframeHotkey();

        const win = frame.contentWindow;

        // Safe nav patches (donâ€™t redefine location property)
        win.open = (u) => { loadPage(deproxify(u, remoteUrl)); return null; };
        try {
            win.location.assign = (u) => loadPage(deproxify(u, remoteUrl));
            win.location.replace = (u) => loadPage(deproxify(u, remoteUrl));
            win.location.reload  = ()  => loadPage(remoteUrl);
        } catch {}

        // Links
        doc.addEventListener("click", e => {
            const a = e.target.closest("a");
            if (!a) return;
            e.preventDefault();
            const rawHref = a.getAttribute("href") || a.href;
            const next = deproxify(rawHref, remoteUrl);
            loadPage(next);
        });

        // Forms
        doc.addEventListener("submit", e => {
            const form = e.target.closest("form");
            if (!form) return;

            e.preventDefault();

            const rawAction = form.getAttribute("action") || "";
            const action = deproxify(rawAction || remoteUrl, remoteUrl);
            const fd = new FormData(form);
            const params = new URLSearchParams(fd);

            if ((form.method || "get").toLowerCase() === "post") {
                fetch(server.href + "?url=" + encodeURIComponent(action), {
                    method: "POST",
                    body: params,
                    headers: { "Content-Type": "application/x-www-form-urlencoded" },
                    credentials: "include"
                })
                .then(r => r.text())
                .then(html => renderIntoIframe(html, action));
            } else {
                const urlWithQs = action + (action.includes("?") ? "&" : "?") + params.toString();
                loadPage(urlWithQs);
            }
        }, true);

        // Meta refresh
        doc.querySelectorAll('meta[http-equiv="refresh"]').forEach(meta => {
            const content = meta.getAttribute("content") || "";
            const match = content.match(/^\s*(\d+)\s*;\s*url=(.+)$/i);
            if (match) {
            const delay = parseInt(match[1], 10) * 1000;
            const raw = match[2].trim();
            const next = deproxify(raw, remoteUrl);
            setTimeout(() => loadPage(next), delay);
            }
        });

        const noop = () => {};

        win.history.pushState = () => {}
        win.history.replaceState = () => {}
        win.addEventListener("popstate", e => {} );
        injectMutationObserver(win, serverUrl + "?url=" + encodeURIComponent(remoteUrl), serverUrl, targetUrl)
    }
    function injectMutationObserver(targetWindow, rewriteUrl, serverUrl, targetUrl) {
        const attrMap = {
            a: "href",
            link: "href",
            img: "src",
            script: "src",
            iframe: "src",
            frame: "src",
            embed: "src",
            object: "data",
            source: "src",
            track: "src",
            audio: "src",
            video: "src",
            form: "action",
            area: "href",
        };

        const script = `
            (function() {
                const attrMap = ${JSON.stringify(attrMap)};
                const serverUrl = "${serverUrl}";
                const targetUrl = "${targetUrl}";

                function rewriteUrlSafe(url) {
                    try {
                        const absoluteUrl = new URL(url, targetUrl).href;
                        return serverUrl + "?url=" + encodeURIComponent(absoluteUrl);
                    } catch {
                        return url;
                    }
                }

                function rewriteCss(css) {
                    if (!css) return css;
                    return css.replace(/url\(\\s*(['"]?)(.*?)\\1\s*\\)/g, (_, quote, url) => {
                        let clean = url.trim();
                        if (clean.startsWith("data:")) return \`url(\${url})\`;
                        return \`url(\${rewriteUrlSafe(clean)})\`;
                    });
                }

                function rewriteElement(el) {
                    // attributes
                    for (const [tag, attr] of Object.entries(attrMap)) {
                        if (el.tagName && el.tagName.toLowerCase() === tag) {
                            let val = el.getAttribute(attr);
                            if (val && !val.startsWith("data:") && !val.startsWith("javascript:")) {
                                el.setAttribute(attr, rewriteUrlSafe(val));
                            }
                        }
                    }

                    // inline styles
                    if (el.hasAttribute && el.hasAttribute("style")) {
                        el.setAttribute("style", rewriteCss(el.getAttribute("style")));
                    }

                    // style tags
                    if (el.tagName && el.tagName.toLowerCase() === "style") {
                        el.textContent = rewriteCss(el.textContent);
                    }

                    // srcsets
                    if (el.tagName && ["img", "source"].includes(el.tagName.toLowerCase())) {
                        let srcset = el.getAttribute("srcset");
                        if (srcset) {
                            let rewritten = srcset
                                .split(",")
                                .map(entry => {
                                    let [url, size] = entry.trim().split(/\\s+/, 2);
                                    return rewriteUrlSafe(url) + (size ? " " + size : "");
                                })
                                .join(", ");
                            el.setAttribute("srcset", rewritten);
                        }
                    }
                }

                const observer = new MutationObserver(mutations => {
                    for (const mutation of mutations) {
                        mutation.addedNodes.forEach(node => {
                            if (node.nodeType === Node.ELEMENT_NODE) {
                                rewriteElement(node);
                                node.querySelectorAll && node.querySelectorAll("*").forEach(rewriteElement);
                            }
                        });
                    }
                });

                observer.observe(document.documentElement, { childList: true, subtree: true });

                document.querySelectorAll("*").forEach(rewriteElement);
            })();
        `;

        const scriptEl = targetWindow.document.createElement("script");
        scriptEl.textContent = script;
        try {
            targetWindow.document.body.appendChild(scriptEl);
        } catch {}
    }


    async function loadPage(rawRemoteUrl, search = false) {
        let remoteUrl = rawRemoteUrl;

        if (rawRemoteUrl === "about:blank") {
            if (document.getElementById("page")) document.getElementById("page").remove();
            return;
        }
        if (search) {
            if (remoteUrl.includes(" ") || !remoteUrl.includes(".")) {
                remoteUrl = "startpage.com/sp/search?q=" + rawRemoteUrl.replaceAll(" ", "+");
            }
        }
        if (!remoteUrl.startsWith("http://") && !remoteUrl.startsWith("https://")) {
            remoteUrl = "http://" + remoteUrl;
        }
        const raw = await fetch(server.href + "?url=" + encodeURIComponent(remoteUrl), {
            credentials: 'include'
        });
        const html = await raw.text();
        renderIntoIframe(html, remoteUrl);
    }

    window.loadPage = loadPage;
    loadPage(targetUrl);
</script>
</body>
</html>
